<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ô–∞–∞–∞–∞</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,Arial}
  body{ background:#000; }

  /* –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–æ–µ–º –ø–æ–¥ –∫–∞–Ω–≤–∞—Å–æ–º */
  #bg{
    position:fixed; left:0; top:0;
    width:100vw;

    /* –ö–∞—Å–∫–∞–¥ –∑–Ω–∞—á–µ–Ω–∏–π –≤—ã—Å–æ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ (—á—Ç–æ–±—ã –Ω–∏–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª –≤–∏–¥–µ–Ω) */
    height:100vh;
    height:-webkit-fill-available;
    height:100svh;
    height:100dvh;

    /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–ø–∏—Å—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ –≤—ã—Å–æ—Ç–µ; –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ */
    object-fit:contain;
    object-position:center bottom;
    z-index:0; pointer-events:none;
    transition:object-fit .2s ease;
  }

  /* –ú–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã: –∑–∞–ø–æ–ª–Ω—è–µ–º —ç–∫—Ä–∞–Ω –±–µ–∑ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª–æ—Å,
     —Å–º–µ—â–∞–µ–º —Ñ–æ–Ω –∫ –ø—Ä–∞–≤–æ–º—É –Ω–∏–∂–Ω–µ–º—É —É–≥–ª—É —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º ‚Äú–æ—Ç—Å—Ç—É–ø–æ–º‚Äù 30px —Å–ø—Ä–∞–≤–∞ */
  @media (max-width: 820px), (max-height: 640px){
    #bg{
      object-fit:cover;
      object-position:right bottom;
      width:calc(100vw + 60px);

      /* –¢–æ—Ç –∂–µ –∫–∞—Å–∫–∞–¥ –≤—ã—Å–æ—Ç—ã, —á—Ç–æ –∏ –≤—ã—à–µ */
      height:100vh;
      height:-webkit-fill-available;
      height:100svh;
      height:100dvh;

      left:auto; right:-30px;
    }
  }

  /* –ö–∞–Ω–≤–∞—Å –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ —Ä–∞–∑–º–µ—Ä—É —Å –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç—å—é */
  canvas{
    position:fixed; inset:0; display:block; z-index:2; background:transparent;
    width:100vw;

    /* –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –∫–∞–Ω–≤–∞—Å–∞ —Å —Ä–µ–∞–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π –æ–∫–Ω–∞ */
    height:100vh;
    height:-webkit-fill-available;
    height:100svh;
    height:100dvh;
  }

  /* –ö–Ω–æ–ø–∫–∏-—ç–º–æ–¥–∑–∏ –≤ —É–≥–ª–∞—Ö (–∑–≤—É–∫ ‚Äî —Å–ª–µ–≤–∞, –º–µ—Ç–ª–∞ ‚Äî —Å–ø—Ä–∞–≤–∞) */
  .mute-btn{
    position:fixed;
    left: max(8px, env(safe-area-inset-left));
    top:  max(8px, env(safe-area-inset-top));
    z-index:4;
    width:44px; height:44px;
    border:0; border-radius:12px;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    color:#fff; font-size:22px; line-height:1;
    display:grid; place-items:center;
    cursor:pointer; user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .clear-btn{
    position:fixed;
    right: max(8px, env(safe-area-inset-right));
    top:   max(8px, env(safe-area-inset-top));
    z-index:4;
    width:44px; height:44px;
    border:0; border-radius:12px;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    color:#fff; font-size:22px; line-height:1;
    display:grid; place-items:center;
    cursor:pointer; user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
</style>
</head>
<body>

<img id="bg" src="img/background.jpg" alt="">
<canvas id="cv"></canvas>

<!-- –ö–Ω–æ–ø–∫–∏-—ç–º–æ–¥–∑–∏ -->
<button id="muteBtn" class="mute-btn"  type="button" aria-label="–ó–≤—É–∫">üîá</button>
<button id="clearBtn" class="clear-btn" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –±–ª–æ–∫–∏">üßπ</button>

<audio id="bgm" src="audio/khrushch_vibes.mp3" preload="auto" loop></audio>
<audio id="hit" src="audio/khrushch_upal.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
/* ---------------- –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------------- */
const cv = document.getElementById('cv');
let W = innerWidth, H = innerHeight;
let render;

const bgm = document.getElementById('bgm');
const hit = document.getElementById('hit');

/* –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏ (—Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
(function startAudio(){
  try{
    const p = bgm.play();
    if (p && p.catch) {
      p.catch(()=>{
        const resume=()=>{ bgm.play().catch(()=>{}); ['click','touchstart','keydown'].forEach(t=>document.removeEventListener(t,resume)); };
        ['click','touchstart','keydown'].forEach(t=>document.addEventListener(t,resume,{once:true}));
      });
    }
  }catch(e){}
})();

/* ---------------- –†–∞–±–æ—Ç–∞ —Å–æ —Å–ø—Ä–∞–π—Ç–∞–º–∏ –±–ª–æ–∫–æ–≤ ---------------- */
const IMG_SRCS = ["img/khrushch0.jpg","img/khrushch1.jpg","img/khrushch2.jpg","img/khrushch3.jpg","img/khrushch4.jpg"];
let SPRITES = []; // [{texture,w,h}]

/* –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Ö –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ */
function preloadImages(srcs){
  return Promise.all(srcs.map(src => new Promise(res=>{
    const im=new Image();
    im.onload=()=>res({texture:src, w:im.naturalWidth||im.width, h:im.naturalHeight||im.height});
    im.onerror=()=>res({texture:src, w:100, h:50});
    im.src=src;
  })));
}

/* –í—ã–±–æ—Ä —Å–ø—Ä–∞–π—Ç–∞ –∏ —Ä–∞—Å—á—ë—Ç –µ–≥–æ –º–∞—Å—à—Ç–∞–±–æ–≤ –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ */
function pickSpriteFor(bw,bh){
  if (!SPRITES.length) return { texture: IMG_SRCS[0], xScale: 1, yScale: 1 };
  const s = SPRITES[(Math.random()*SPRITES.length)|0];
  return { texture: s.texture, xScale: (bw/(s.w||bw)), yScale: (bh/(s.h||bh)) };
}

/* ---------------- –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ –ø–æ–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ---------------- */
const BASE_BW = 84, BASE_BH = 42;    // –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞/–ø–ª–∞–Ω—à–µ—Ç–∞
const SMALL_SCALE = 0.7;             // –º–æ–±–∏–ª—å–Ω—ã–µ ‚Äî —É–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞ 30%
let BW = BASE_BW, BH = BASE_BH;

const mqlSmall = window.matchMedia('(max-width: 820px), (max-height: 640px)');
function updateBlockSize(){
  if (mqlSmall.matches){
    BW = Math.round(BASE_BW * SMALL_SCALE);
    BH = Math.round(BASE_BH * SMALL_SCALE);
  } else {
    BW = BASE_BW;
    BH = BASE_BH;
  }
}

/* ---------------- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–∑–∏–∫–∏ –∏ –º–∞—è—Ç–Ω–∏–∫–∞ ---------------- */
const FIXED_DT = 1000/60;
const STEP_S = FIXED_DT/1000;
const BASE_GRAVITY = 1.0;
const MAX_ANGLE = Math.PI/3;

/* –°–∫–æ—Ä–æ—Å—Ç—å –∫–∞—á–∞–Ω–∏—è: –ø–µ—Ä–∏–æ–¥ 3.3s (–º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ) */
const SWING_PERIOD_S = 3.3;
const OMEGA = 2*Math.PI/SWING_PERIOD_S;
let phase = 0, phaseStep = OMEGA*STEP_S;

const TOP_OFFSET = 24;                      // –≤—ã—Å–æ—Ç–∞ —Ç–æ—á–∫–∏ –ø–æ–¥–≤–µ—Å–∞ –æ—Ç –≤–µ—Ä—Ö–∞ —ç–∫—Ä–∞–Ω–∞
const pivot = {x:W/2, y:TOP_OFFSET};        // —Ç–æ—á–∫–∞ –ø–æ–¥–≤–µ—Å–∞
const ARC_FRACTION=0.22, ARC_MAX_PX=180, ARC_MIN_PX=70; // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ –¥—É–≥–∏
let ropeLen=80;                              // –¥–ª–∏–Ω–∞ ¬´–≤–µ—Ä—ë–≤–∫–∏¬ª (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)

/* –ü–µ—Ä–µ—Ä–∞—Å—á—ë—Ç –¥–ª–∏–Ω—ã –º–∞—è—Ç–Ω–∏–∫–∞/–∞–º–ø–ª–∏—Ç—É–¥—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–∫–Ω–∞ */
function recomputePendulum(){
  let ampX=W*ARC_FRACTION;
  if(ampX>ARC_MAX_PX) ampX=ARC_MAX_PX;
  if(ampX<ARC_MIN_PX) ampX=ARC_MIN_PX;
  ropeLen=Math.max(60, ampX/Math.sin(MAX_ANGLE));
  const maxBottom=H-120;
  if(pivot.y+ropeLen>maxBottom) ropeLen=Math.max(60, maxBottom-pivot.y);
}

/* –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Ä–µ—Å–∞–π–∑/–ø–æ–≤–æ—Ä–æ—Ç —ç–∫—Ä–∞–Ω–∞: –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã, —Ñ–æ–Ω –∏ –≥—Ä–∞–Ω–∏—Ü—ã */
function resize(){
  W=innerWidth; H=innerHeight;
  cv.width=W; cv.height=H;
  if(render){
    render.canvas.width=W; render.canvas.height=H;
    render.options.width=W; render.options.height=H;
  }
  pivot.x=W/2;
  if(engine) engine.gravity.y=BASE_GRAVITY;
  updateBlockSize();     // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ –ø–æ–¥ —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
  recomputePendulum();
  updateBgMode();
  rebuildBounds();
}

/* ---------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Matter.js ---------------- */
const {Engine,Render,World,Bodies,Body,Events} = Matter;
const engine=Engine.create();
engine.gravity.y=BASE_GRAVITY;
engine.timing.timeScale=1;

render=Render.create({ canvas:cv, engine, options:{width:W,height:H,background:'transparent',wireframes:false}});
Render.run(render);

/* ---------------- –ò–≥—Ä–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ –≤–∏–¥–∏–º–æ–π —á–∞—Å—Ç–∏ —Ñ–æ–Ω–∞ ---------------- */
let wallL, wallR, ground;
const bgEl=document.getElementById('bg');
let bgRatio=null;     // —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
let useCoverMid=false;

/* –ü—Ä–∏ —Å–º–µ–Ω–µ ‚Äú–º–∞–ª–µ–Ω—å–∫–æ–≥–æ‚Äù —Ä–µ–∂–∏–º–∞ ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã/–≥—Ä–∞–Ω–∏—Ü—ã */
(mqlSmall.addEventListener ? mqlSmall.addEventListener('change', ()=>{ updateBlockSize(); updateBgMode(); rebuildBounds(); }) : mqlSmall.addListener(()=>{ updateBlockSize(); updateBgMode(); rebuildBounds(); }));

/* –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–∞–∂–µ –µ—Å–ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ) */
function ensureBgRatio(){ if(bgEl.naturalWidth && bgEl.naturalHeight) bgRatio = bgEl.naturalWidth/bgEl.naturalHeight; }
if (bgEl.complete) ensureBgRatio();
bgEl.addEventListener('load', ()=>{ ensureBgRatio(); updateBgMode(); rebuildBounds(); });

/* –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Ñ–æ–Ω–∞ –Ω–∞ –Ω–µ-–º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö:
   - cover, –µ—Å–ª–∏ –æ–∫–Ω–æ ‚Äú–≤—ã—Å–æ–∫–æ–µ‚Äù (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–ª–æ—Å —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É),
   - contain –∏–Ω–∞—á–µ (–ø–æ–ª–æ—Å—ã —Ç–æ–ª—å–∫–æ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞). */
function updateBgMode(){
  if (mqlSmall.matches){
    useCoverMid = false; // –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —É–ø—Ä–∞–≤–ª—è–µ—Ç CSS
  } else {
    if (!bgRatio){ useCoverMid = false; return; }
    const vpRatio = W / H;
    useCoverMid = (vpRatio < bgRatio);
    if (useCoverMid){
      bgEl.style.objectFit = 'cover';
      bgEl.style.objectPosition = 'center bottom';
      bgEl.style.width = '100vw';
      bgEl.style.left = '0';
      bgEl.style.right = 'auto';
    }else{
      bgEl.style.objectFit = 'contain';
      bgEl.style.objectPosition = 'center bottom';
      bgEl.style.width = '100vw';
      bgEl.style.left = '0';
      bgEl.style.right = 'auto';
    }
  }
}

/* –õ–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü—ã –∑–æ–Ω—ã –∏–≥—Ä—ã (–ø–æ –≤–∏–¥–∏–º–æ–π —à–∏—Ä–∏–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏) */
let playBounds={left:0,right:W};
function getPlayBounds(){
  if (mqlSmall.matches) return {left:0, right:W};
  if (useCoverMid) return {left:0, right:W};
  if (!bgRatio) return {left:0, right:W};
  const imgWidth = Math.min(W, H*bgRatio);
  const left = (W - imgWidth)/2;
  return {left, right:left+imgWidth};
}

/* –ú—è–≥–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ–ª, –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã—à–ª–∏ –∑–∞ –Ω–æ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É */
function clampBodiesToBounds(bounds){
  const minX=bounds.left, maxX=bounds.right;
  for (const b of engine.world.bodies){
    if (b.isStatic) continue;
    const halfW=(b.bounds.max.x - b.bounds.min.x)/2;
    let x=b.position.x, clamped=false;
    if (x-halfW<minX){ x=minX+halfW; clamped=true; }
    if (x+halfW>maxX){ x=maxX-halfW; clamped=true; }
    if (clamped){ Body.setPosition(b,{x,y:b.position.y}); Body.setVelocity(b,{x:0,y:b.velocity.y}); }
  }
}

/* –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ (–∏–ª–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞) —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Å—Ç–µ–Ω –∏ –∑–µ–º–ª–∏ –ø–æ–¥ —Ç–µ–∫—É—â—É—é –≤–∏–¥–∏–º—É—é —à–∏—Ä–∏–Ω—É —Ñ–æ–Ω–∞ */
function rebuildBounds(){
  const {left,right}=getPlayBounds();
  playBounds.left=left; playBounds.right=right;

  if (wallL) World.remove(engine.world,[wallL,wallR,ground]);

  const thickness=200;
  wallL=Bodies.rectangle(left - thickness/2, H/2, thickness, H*6, {isStatic:true, label:'wall', render:{visible:false}});
  wallR=Bodies.rectangle(right + thickness/2, H/2, thickness, H*6, {isStatic:true, label:'wall', render:{visible:false}});
  ground=Bodies.rectangle((left+right)/2, H-40, (right-left)+thickness, 80, {isStatic:true, label:'ground', render:{visible:false}});
  World.add(engine.world,[wallL,wallR,ground]);

  clampBodiesToBounds(playBounds);
}

resize();
addEventListener('resize', ()=>{ resize(); });

/* ---------------- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---------------- */
const grassHeight=75;
const baseCenterY=H - grassHeight/2;

let current=null, dropping=null;
let baseBody=null;

/* –°—Ç–∞—Ä—Ç: –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—ã–π ¬´–º–∞—è—Ç–Ω–∏–∫–æ–≤—ã–π¬ª –±–ª–æ–∫ */
preloadImages(IMG_SRCS).then(sprites=>{
  SPRITES=sprites;

  const base=Bodies.rectangle(
    W/2, baseCenterY, BW, BH,
    {label:'block', restitution:0.05, friction:0.9, frictionAir:0, render:{sprite:pickSpriteFor(BW,BH)}}
  );
  baseBody = base;                // –±–∞–∑–æ–≤—ã–π –±–ª–æ–∫ ‚Äî –Ω–µ —É–¥–∞–ª—è–µ–º –º–µ—Ç–ª–æ–π
  World.add(engine.world, base);
  newBlock();
});

/* –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ–¥–≤–µ—à–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –µ–≥–æ –≤ —Ä–µ–∂–∏–º ¬´–º–∞—è—Ç–Ω–∏–∫–∞¬ª (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ, –ø–æ–∑–∏—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é) */
function newBlock(){
  const theta=MAX_ANGLE*Math.sin(phase);
  const x=pivot.x + ropeLen*Math.sin(theta);
  const y=pivot.y + ropeLen*Math.cos(theta);

  current=Bodies.rectangle(
    x, y, BW, BH,
    {label:'block', restitution:0.05, friction:0.9, frictionAir:0, render:{sprite:pickSpriteFor(BW,BH)}}
  );
  Body.setStatic(current,true);
  World.add(engine.world,current);
}

/* –°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫: –ø—Ä–∏–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é/—Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π –∏ –æ—Ç–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–∏–∑–∏–∫—É */
function drop(){
  if(!current) return;

  const theta=MAX_ANGLE*Math.sin(phase);
  const dtheta_dt=MAX_ANGLE*Math.cos(phase)*OMEGA;

  const s=Math.sin(theta), c=Math.cos(theta);
  let x=pivot.x + ropeLen*s;
  const y=pivot.y + ropeLen*c;

  const halfW=BW/2;
  x=Math.max(playBounds.left+halfW, Math.min(playBounds.right-halfW, x));

  const vx_step= ropeLen*c*dtheta_dt*STEP_S;
  const vy_step=-ropeLen*s*dtheta_dt*STEP_S;

  Body.setPosition(current,{x,y});
  Body.setStatic(current,false);
  Body.set(current,{frictionAir:0});
  Body.setVelocity(current,{x:vx_step,y:vy_step});

  dropping=current;
  current=null; // –Ω–æ–≤—ã–π –ø–æ–¥–≤–µ—à–µ–Ω–Ω—ã–π —Å–æ–∑–¥–∞–¥–∏–º –ø–æ—Å–ª–µ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è
}

/* –ó–≤—É–∫ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è –∏ —Å–ø–∞–≤–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–∞—Å–∞–Ω–∏–∏ –∑–µ–º–ª–∏/—Å—Ç–æ–ø–∫–∏ */
Events.on(engine,'collisionStart',(evt)=>{
  if(!dropping) return;
  for(const pair of evt.pairs){
    const a=pair.bodyA, b=pair.bodyB;
    if (a===current || b===current) continue;
    const involvesDrop=(a===dropping || b===dropping);
    const other=(a===dropping)?b:(b===dropping?a:null);
    if(involvesDrop && other && (other.label==='ground' || other.label==='block')){
      try{ hit.currentTime=0; hit.play(); }catch(e){}
      dropping=null;
      newBlock();
      break;
    }
  }
});

/* –ê–Ω–∏–º–∞—Ü–∏—è –º–∞—è—Ç–Ω–∏–∫–∞: –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—É –∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–¥–≤–µ—à–µ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º —Ñ–∏–∑–∏–∫–∏ */
Events.on(engine,'beforeUpdate',()=>{
  if(current){
    phase+=phaseStep;
    const theta=MAX_ANGLE*Math.sin(phase);
    const x=pivot.x + ropeLen*Math.sin(theta);
    const y=pivot.y + ropeLen*Math.cos(theta);
    Body.setPosition(current,{x,y});
  }
});

/* ---------------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ---------------- */
/* –ö–ª–∏–∫/—Ç–∞–ø –ø–æ —ç–∫—Ä–∞–Ω—É ‚Äî —Å–±—Ä–æ—Å –±–ª–æ–∫–∞ */
function handleInput(e){ if(e.type==='touchstart') e.preventDefault(); drop(); }
cv.addEventListener('click', handleInput, {passive:true});
cv.addEventListener('touchstart', handleInput, {passive:false});

/* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: Space / Enter / ArrowDown ‚Äî —Å–±—Ä–æ—Å –±–ª–æ–∫–∞ */
function handleKey(e){
  const c = e.code || e.key;
  if (c === 'Space' || c === 'Enter' || c === 'ArrowDown' || e.key === ' '){
    e.preventDefault();
    drop();
  }
}
document.addEventListener('keydown', handleKey);

/* –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫–∞ (—ç–º–æ–¥–∑–∏): –≤–∫–ª—é—á–∞–µ—Ç/—Å—Ç–∞–≤–∏—Ç –Ω–∞ –ø–∞—É–∑—É —Ñ–æ–Ω bgm */
const muteBtn = document.getElementById('muteBtn');
function syncMuteBtn(){ muteBtn.textContent = (!bgm.paused && !bgm.muted) ? 'üîä' : 'üîá'; }
muteBtn.addEventListener('click', async () => {
  try{
    if (bgm.paused) { await bgm.play(); }
    else { bgm.pause(); }
  }catch(e){}
  syncMuteBtn();
});
bgm.addEventListener('play', syncMuteBtn);
bgm.addEventListener('pause', syncMuteBtn);
syncMuteBtn();

/* –ö–Ω–æ–ø–∫–∞-–º–µ—Ç–ª–∞: —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —É–ø–∞–≤—à–∏–µ –±–ª–æ–∫–∏, –∫—Ä–æ–º–µ –±–∞–∑–æ–≤–æ–≥–æ –∏ —Ç–µ—Ö, —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –ø–æ–ª—ë—Ç–µ/–Ω–∞ –≤–µ—Ä—ë–≤–∫–µ */
const clearBtn = document.getElementById('clearBtn');
function clearFallen(){
  const toRemove=[];
  for (const b of engine.world.bodies){
    if (b.label==='block' && !b.isStatic && b!==current && b!==dropping && b!==baseBody){
      toRemove.push(b);
    }
  }
  if (toRemove.length) World.remove(engine.world, toRemove);
}
clearBtn.addEventListener('click', clearFallen);

/* ---------------- –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —à–∞–≥–æ–º —Ñ–∏–∑–∏–∫–∏ ---------------- */
const STEP_MS=FIXED_DT, MAX_STEPS=20;
let last=performance.now(), acc=0;
(function loop(){
  const now=performance.now(); let delta=now-last; last=now;
  if(delta>250) delta=250; acc+=delta;     // –∑–∞—â–∏—Ç–∞ –æ—Ç ‚Äú—Å–∫–∞—á–∫–æ–≤‚Äù –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
  let steps=0;
  while(acc>=STEP_MS && steps<MAX_STEPS){ Engine.update(engine,STEP_MS); acc-=STEP_MS; steps++; }
  if(steps===MAX_STEPS) acc=0;             // –∏–∑–±–µ–≥–∞–µ–º ‚Äú—Å–ø–∏—Ä–∞–ª–∏ —Å–º–µ—Ä—Ç–∏‚Äù –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –ª–∞–≥–∞—Ö
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
